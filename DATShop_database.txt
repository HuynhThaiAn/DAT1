/* =========================
   DATABASE: DATShop
   ========================= */

IF DB_ID('DATShop') IS NULL
    CREATE DATABASE DATShop;
GO
USE DATShop;
GO

/* =========================
   ACCOUNT
========================= */
CREATE TABLE dbo.Customers (
    CustomerID    INT IDENTITY(1,1) PRIMARY KEY,
    Email         NVARCHAR(255) NOT NULL UNIQUE,
    PasswordHash  NVARCHAR(255) NOT NULL,
    FullName      NVARCHAR(150) NOT NULL,
    Phone         NVARCHAR(30)  NULL,
    AvatarUrl     NVARCHAR(500) NULL,
    IsBlocked     BIT NOT NULL DEFAULT 0,
    CreatedAt     DATETIME2 NOT NULL DEFAULT SYSDATETIME(),
    UpdatedAt     DATETIME2 NULL
);

CREATE TABLE dbo.Staff (
    StaffID       INT IDENTITY(1,1) PRIMARY KEY,
    Email         NVARCHAR(255) NOT NULL UNIQUE,
    PasswordHash  NVARCHAR(255) NOT NULL,
    FullName      NVARCHAR(150) NOT NULL,
    Phone         NVARCHAR(30)  NULL,
    Role          TINYINT NOT NULL DEFAULT 1, -- 1=STAFF, 2=ADMIN
    IsDeleted     BIT NOT NULL DEFAULT 0,
    CreatedAt     DATETIME2 NOT NULL DEFAULT SYSDATETIME(),
    UpdatedAt     DATETIME2 NULL
);

CREATE TABLE dbo.Addresses (
    AddressID      INT IDENTITY(1,1) PRIMARY KEY,
    CustomerID     INT NOT NULL,
    RecipientName  NVARCHAR(150) NOT NULL,
    Phone          NVARCHAR(30)  NOT NULL,
    Province       NVARCHAR(100) NOT NULL,
    District       NVARCHAR(100) NOT NULL,
    Ward           NVARCHAR(100) NOT NULL,
    DetailAddress  NVARCHAR(255) NOT NULL,
    IsDefault      BIT NOT NULL DEFAULT 0,
    IsActive       BIT NOT NULL DEFAULT 1,
    CreatedAt      DATETIME2 NOT NULL DEFAULT SYSDATETIME(),
    UpdatedAt      DATETIME2 NULL,
    CONSTRAINT FK_Addresses_Customers FOREIGN KEY (CustomerID) REFERENCES dbo.Customers(CustomerID)
);

/* =========================
   PRODUCT 
========================= */
CREATE TABLE dbo.Categories (
    CategoryID    INT IDENTITY(1,1) PRIMARY KEY,
    CategoryName  NVARCHAR(120) NOT NULL UNIQUE,
    Description   NVARCHAR(1000) NULL,
    ImgUrlLogo    NVARCHAR(500) NULL,
    IsDeleted     BIT NOT NULL DEFAULT 0,
    CreatedAt     DATETIME2 NOT NULL DEFAULT SYSDATETIME(),
    UpdatedAt     DATETIME2 NULL
);

CREATE TABLE dbo.Brands (
    BrandID      INT IDENTITY(1,1) PRIMARY KEY,
    BrandName    NVARCHAR(120) NOT NULL UNIQUE,
    Description  NVARCHAR(1000) NULL,
    LogoUrl      NVARCHAR(500) NULL,
    IsDeleted    BIT NOT NULL DEFAULT 0,
    CreatedAt    DATETIME2 NOT NULL DEFAULT SYSDATETIME(),
    UpdatedAt    DATETIME2 NULL
);

CREATE TABLE dbo.Products (
    ProductID    INT IDENTITY(1,1) PRIMARY KEY,
    CategoryID   INT NOT NULL,
    BrandID      INT NULL,
    ProductName  NVARCHAR(200) NOT NULL,
    Description  NVARCHAR(MAX) NULL,
    IsDeleted    BIT NOT NULL DEFAULT 0,
    CreatedAt    DATETIME2 NOT NULL DEFAULT SYSDATETIME(),
    UpdatedAt    DATETIME2 NULL,
    CONSTRAINT FK_Products_Categories FOREIGN KEY (CategoryID) REFERENCES dbo.Categories(CategoryID),
    CONSTRAINT FK_Products_Brands     FOREIGN KEY (BrandID)     REFERENCES dbo.Brands(BrandID)
);

CREATE TABLE dbo.ProductVariants (
    VariantID      INT IDENTITY(1,1) PRIMARY KEY,
    ProductID      INT NOT NULL,
    SKU            NVARCHAR(80)  NOT NULL UNIQUE,
    VariantName    NVARCHAR(120) NOT NULL,
    Price          DECIMAL(18,2) NOT NULL,
    StockQuantity  INT NOT NULL DEFAULT 0,
    IsActive       BIT NOT NULL DEFAULT 1,
    CreatedAt      DATETIME2 NOT NULL DEFAULT SYSDATETIME(),
    UpdatedAt      DATETIME2 NULL,
    CONSTRAINT FK_Variants_Products FOREIGN KEY (ProductID) REFERENCES dbo.Products(ProductID)
);

CREATE TABLE dbo.ProductImages (
    ImageID     INT IDENTITY(1,1) PRIMARY KEY,
    ProductID   INT NOT NULL,
    ImageUrl    NVARCHAR(500) NOT NULL,
    IsMain      BIT NOT NULL DEFAULT 0,
    CreatedAt   DATETIME2 NOT NULL DEFAULT SYSDATETIME(),
    CONSTRAINT FK_Images_Products FOREIGN KEY (ProductID) REFERENCES dbo.Products(ProductID)
);

CREATE TABLE dbo.CategoryAttributeGroups (
    GroupID     INT IDENTITY(1,1) PRIMARY KEY,
    CategoryID  INT NOT NULL,
    GroupName   NVARCHAR(120) NOT NULL,
    IsDeleted   BIT NOT NULL DEFAULT 0,
    CONSTRAINT FK_CAG_Categories FOREIGN KEY (CategoryID) REFERENCES dbo.Categories(CategoryID)
);

CREATE TABLE dbo.CategoryAttributes (
    AttributeID    INT IDENTITY(1,1) PRIMARY KEY,
    GroupID        INT NOT NULL,
    AttributeName  NVARCHAR(120) NOT NULL,
    Unit           NVARCHAR(30)  NULL,
    DataType       TINYINT NOT NULL DEFAULT 1, -- 1=text, 2=number
    IsDeleted      BIT NOT NULL DEFAULT 0,
    CONSTRAINT FK_CA_Groups FOREIGN KEY (GroupID) REFERENCES dbo.CategoryAttributeGroups(GroupID)
);

CREATE TABLE dbo.ProductAttributeValues (
    ProductID    INT NOT NULL,
    AttributeID  INT NOT NULL,
    Value        NVARCHAR(500) NOT NULL,
    PRIMARY KEY (ProductID, AttributeID),
    CONSTRAINT FK_PAV_Product   FOREIGN KEY (ProductID)   REFERENCES dbo.Products(ProductID),
    CONSTRAINT FK_PAV_Attribute FOREIGN KEY (AttributeID) REFERENCES dbo.CategoryAttributes(AttributeID)
);

CREATE TABLE dbo.VariantAttributeValues (
    VariantID    INT NOT NULL,
    AttributeID  INT NOT NULL,
    Value        NVARCHAR(500) NOT NULL,
    PRIMARY KEY (VariantID, AttributeID),
    CONSTRAINT FK_VAV_Variant   FOREIGN KEY (VariantID)   REFERENCES dbo.ProductVariants(VariantID),
    CONSTRAINT FK_VAV_Attribute FOREIGN KEY (AttributeID) REFERENCES dbo.CategoryAttributes(AttributeID)
);

/* =========================
   ORDER
========================= */
CREATE TABLE dbo.Cart (
    CustomerID  INT NOT NULL,
    VariantID   INT NOT NULL,
    Quantity    INT NOT NULL,
    AddedAt     DATETIME2 NOT NULL DEFAULT SYSDATETIME(),
    UpdatedAt   DATETIME2 NULL,
    PRIMARY KEY (CustomerID, VariantID),
    CONSTRAINT FK_Cart_Customer FOREIGN KEY (CustomerID) REFERENCES dbo.Customers(CustomerID),
    CONSTRAINT FK_Cart_Variant  FOREIGN KEY (VariantID)  REFERENCES dbo.ProductVariants(VariantID)
);

CREATE TABLE dbo.Orders (
    OrderID        INT IDENTITY(1,1) PRIMARY KEY,
    CustomerID     INT NOT NULL,

    ReceiverName   NVARCHAR(150) NOT NULL,
    Phone          NVARCHAR(30)  NOT NULL,
    Province       NVARCHAR(100) NOT NULL,
    District       NVARCHAR(100) NOT NULL,
    Ward           NVARCHAR(100) NOT NULL,
    DetailAddress  NVARCHAR(255) NOT NULL,

    TotalAmount    DECIMAL(18,2) NOT NULL DEFAULT 0,
    Status         TINYINT NOT NULL DEFAULT 1,

    OrderedAt      DATETIME2 NOT NULL DEFAULT SYSDATETIME(),
    PaidAt         DATETIME2 NULL,
    ShippedAt      DATETIME2 NULL,
    DeliveredAt    DATETIME2 NULL,
    CancelledAt    DATETIME2 NULL,

    Note           NVARCHAR(500) NULL,

    CONSTRAINT FK_Orders_Customers FOREIGN KEY (CustomerID) REFERENCES dbo.Customers(CustomerID)
);

CREATE TABLE dbo.OrderDetails (
    OrderID    INT NOT NULL,
    VariantID  INT NOT NULL,
    UnitPrice  DECIMAL(18,2) NOT NULL,
    Quantity   INT NOT NULL,
    PRIMARY KEY (OrderID, VariantID),
    CONSTRAINT FK_OD_Order   FOREIGN KEY (OrderID)   REFERENCES dbo.Orders(OrderID),
    CONSTRAINT FK_OD_Variant FOREIGN KEY (VariantID) REFERENCES dbo.ProductVariants(VariantID)
);

CREATE TABLE dbo.Payments (
    PaymentID        INT IDENTITY(1,1) PRIMARY KEY,
    OrderID          INT NOT NULL UNIQUE,
    Method           TINYINT NOT NULL,
    Amount           DECIMAL(18,2) NOT NULL,
    Status           TINYINT NOT NULL DEFAULT 1,
    TransactionCode  NVARCHAR(120) NULL,
    PaidAt           DATETIME2 NULL,
    CreatedAt        DATETIME2 NOT NULL DEFAULT SYSDATETIME(),
    CONSTRAINT FK_Payments_Orders FOREIGN KEY (OrderID) REFERENCES dbo.Orders(OrderID)
);

/* =========================
   STOCK / IMPORT
========================= */
CREATE TABLE dbo.Imports (
    ImportID      INT IDENTITY(1,1) PRIMARY KEY,
    StaffID       INT NOT NULL,
    SupplierName  NVARCHAR(200) NULL,
    TotalCost     DECIMAL(18,2) NOT NULL DEFAULT 0,
    Status        TINYINT NOT NULL DEFAULT 1,
    Note          NVARCHAR(500) NULL,
    CreatedAt     DATETIME2 NOT NULL DEFAULT SYSDATETIME(),
    UpdatedAt     DATETIME2 NULL,
    CONSTRAINT FK_Imports_Staff FOREIGN KEY (StaffID) REFERENCES dbo.Staff(StaffID)
);

CREATE TABLE dbo.ImportDetails (
    ImportID  INT NOT NULL,
    VariantID INT NOT NULL,
    UnitCost  DECIMAL(18,2) NOT NULL,
    Quantity  INT NOT NULL,
    PRIMARY KEY (ImportID, VariantID),
    CONSTRAINT FK_ID_Import  FOREIGN KEY (ImportID) REFERENCES dbo.Imports(ImportID),
    CONSTRAINT FK_ID_Variant FOREIGN KEY (VariantID) REFERENCES dbo.ProductVariants(VariantID)
);

/* =========================
   FEEDBACK
========================= */
CREATE TABLE dbo.Feedbacks (
    FeedbackID   INT IDENTITY(1,1) PRIMARY KEY,
    ProductID    INT NOT NULL,
    CustomerID   INT NOT NULL,
    Rating       TINYINT NOT NULL,
    Comment      NVARCHAR(1000) NULL,
    IsVisible    BIT NOT NULL DEFAULT 1,
    CreatedAt    DATETIME2 NOT NULL DEFAULT SYSDATETIME(),
    UpdatedAt    DATETIME2 NULL,
    CONSTRAINT FK_Feedback_Product  FOREIGN KEY (ProductID) REFERENCES dbo.Products(ProductID),
    CONSTRAINT FK_Feedback_Customer FOREIGN KEY (CustomerID) REFERENCES dbo.Customers(CustomerID)
);

CREATE TABLE dbo.FeedbackReplies (
    ReplyID     INT IDENTITY(1,1) PRIMARY KEY,
    FeedbackID  INT NOT NULL,
    StaffID     INT NOT NULL,
    Content     NVARCHAR(1000) NOT NULL,
    IsPublic    BIT NOT NULL DEFAULT 1,
    CreatedAt   DATETIME2 NOT NULL DEFAULT SYSDATETIME(),
    CONSTRAINT FK_FR_Feedback FOREIGN KEY (FeedbackID) REFERENCES dbo.Feedbacks(FeedbackID),
    CONSTRAINT FK_FR_Staff    FOREIGN KEY (StaffID)    REFERENCES dbo.Staff(StaffID)
);
